define(["jquery"],function(t){var n=function(){t(document).ready(function(){console.log("EIRA AI initializing..."),e()})},e=function(){const n=t("#chatbot-toggle-btn"),e=t("#chatbot-window"),o=t("#chatbot-close-btn"),a=t("#chatbot-message-input"),i=t("#chatbot-send-button"),s=t("#chatbot-messages");function c(){u(),t.ajax({url:CHATBOT_CONFIG.wwwroot+"/blocks/chatbot/botman/eira_controller.php",method:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify({command:"welcome_message",context:CHATBOT_CONFIG.context,course:CHATBOT_CONFIG.course,token:CHATBOT_CONFIG.token}),success:function(n){console.log("Welcome message received:",n),l(),n&&n.messages&&Array.isArray(n.messages)?(n.messages.forEach(function(t,n){setTimeout(function(){d(t.text,"bot",t.attachment)},800*n)}),n.messages.length>0&&setTimeout(function(){r(["What are my current courses?","Study tips for exams","Time management advice","Help with assignments","Resources for my studies"])},800*n.messages.length)):d("Hello! I'm EIRA, your academic AI assistant. How can I help you today?","bot")},error:function(t,n,e){console.error("Error getting welcome message:",e),l(),d("Hello! I'm EIRA, your academic AI assistant. How can I help you today?","bot"),setTimeout(function(){d("I can help with your courses, assignments, study tips, and more. What would you like assistance with?","bot")},800)}})}function p(){const n=a.val().trim();if(""===n)return;console.log("Sending message:",n),d(n,"user"),a.val(""),a.css("height","auto"),i.prop("disabled",!0),u();const e=setTimeout(function(){l(),d("I'm sorry, it's taking longer than expected to process your request. Please try again.","bot")},15e3);t.ajax({url:CHATBOT_CONFIG.wwwroot+"/blocks/chatbot/botman/eira_controller.php",method:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify({message:n,context:CHATBOT_CONFIG.context,course:CHATBOT_CONFIG.course,token:CHATBOT_CONFIG.token}),success:function(t){clearTimeout(e),console.log("Response received:",t),l(),t&&t.messages&&Array.isArray(t.messages)?function(){let n="";t.messages.forEach(function(t,e){setTimeout(function(){d(t.text,"bot",t.attachment),n=t.text,e===t.messages.length-1&&setTimeout(function(){m(n)},1e3)},800*e)})}():t&&t.message?(d(t.message,"bot"),setTimeout(function(){m(t.message)},1e3)):d("I've processed your message. Is there anything specific you'd like help with?","bot")},error:function(t,n,o){clearTimeout(e),console.error("Error:",o),l(),d("I'm sorry, I encountered an issue while processing your request. Please try again in a moment.","bot")},complete:function(){a.focus()}})}function d(n,e,o){if(!n)return void console.error("Empty message received");const a=t("<div>").addClass("chatbot-message").addClass("chatbot-"+e+"-message");"object"==typeof n&&n.text&&(n=n.text),n=function(t){if(!t)return"";return t=t.replace(/\n/g,"<br>"),t=t.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),t=t.replace(/\*(.*?)\*/g,"<em>$1</em>"),t=t.replace(/‚Ä¢(.*?)(?=<br>|$)/g,'<span class="chatbot-bullet">‚Ä¢</span>$1'),t=t.replace(/(\d+)\.(.*?)(?=<br>|$)/g,'<span class="chatbot-number">$1.</span>$2'),t=t.replace(/\[(.*?)\]\((.*?)\)/g,'<a href="$2" target="_blank" rel="noopener" class="chatbot-link">$1</a>')}(n),n=function(t){if(!t)return"";const n=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;return t.replace(n,'<a href="$1" target="_blank" rel="noopener" class="chatbot-link">$1</a>')}(n),o&&(o.type==="file"||o.type&&-1!==o.type.indexOf("File")?n+='<br><a href="'+o.url+'" target="_blank" rel="noopener" class="chatbot-link">View File</a>':o.url&&(n+='<br><a href="'+o.url+'" target="_blank" rel="noopener" class="chatbot-link">Open Link</a>'));const i=t("<div>").addClass("chatbot-message-content").html(n),c=t("<div>").addClass("chatbot-timestamp").text(function(t){return t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}(new Date));a.append(i).append(c),"bot"===e&&n.length>50&&function(n){const e=t("<div>").addClass("chatbot-feedback"),o=t("<span>").addClass("chatbot-feedback-label").text("Was this helpful?"),a=t("<button>").addClass("chatbot-feedback-button").html("üëç").attr("title","Yes, this was helpful"),i=t("<button>").addClass("chatbot-feedback-button").html("üëé").attr("title","No, this wasn't helpful");a.on("click",function(){!function(n){t.ajax({url:CHATBOT_CONFIG.wwwroot+"/blocks/chatbot/botman/feedback.php",method:"POST",data:{helpful:n?1:0,token:CHATBOT_CONFIG.token}})}(!0),function(n){n.html('<span class="chatbot-feedback-thanks">Thanks for your feedback!</span>')}(e)}),i.on("click",function(){!function(n){t.ajax({url:CHATBOT_CONFIG.wwwroot+"/blocks/chatbot/botman/feedback.php",method:"POST",data:{helpful:n?1:0,token:CHATBOT_CONFIG.token}})}(!1),function(n){n.html('<span class="chatbot-feedback-thanks">Thanks for your feedback!</span>')}(e)}),e.append(o).append(a).append(i),n.append(e)}(a),s.append(a),s.scrollTop(s[0].scrollHeight)}function r(n){const e=t("<div>").addClass("chatbot-suggestions");n.forEach(function(n){const o=t("<span>").addClass("chatbot-suggestion").text(n).on("click",function(){a.val(n),i.prop("disabled",!1),a.focus(),p()});e.append(o)});const o=t("<div>").addClass("chatbot-message chatbot-bot-message");o.append(e),s.append(o),s.scrollTop(s[0].scrollHeight)}function m(t){if(!t)return;const n=t.toLowerCase();n.includes("study")||n.includes("exam")?r(["How to improve my focus","Memory techniques","Exam anxiety tips","Study schedule help"]):n.includes("assignment")||n.includes("project")?r(["Writing help","Research tips","Time management","Group project advice"]):n.includes("career")||n.includes("job")?r(["Resume writing tips","Interview preparation","Internship opportunities","Career assessment"]):n.includes("resource")||n.includes("tool")?r(["Note-taking apps","Research databases","Study group tools","Academic journals"]):n.includes("course")||n.includes("class")&&r(["Show my assignments","Course materials","Class schedule","Contact my instructor"])}function u(){if(t("#chatbot-typing-indicator").length)return;const n=t("<div>").addClass("chatbot-message chatbot-bot-message chatbot-typing-container").attr("id","chatbot-typing-indicator"),e=t("<div>").addClass("chatbot-typing-indicator");for(let n=0;n<3;n++)e.append(t("<span>"));n.append(e),s.append(n),s.scrollTop(s[0].scrollHeight)}function l(){t("#chatbot-typing-indicator").remove()}if(console.log("EIRA AI elements found:",{toggleBtn:n.length>0,chatWindow:e.length>0,closeBtn:o.length>0,messageInput:a.length>0,sendButton:i.length>0,messagesContainer:s.length>0}),!n.length||!e.length)return void console.error("EIRA AI: Required elements not found");n.on("click",function(){console.log("Toggle button clicked"),e.toggleClass("chatbot-hidden chatbot-visible"),e.hasClass("chatbot-visible")&&(0===s.children().length&&(console.log("Sending welcome message"),c()),a.focus())}),o.on("click",function(){console.log("Close button clicked"),e.removeClass("chatbot-visible").addClass("chatbot-hidden")}),a.on("keydown",function(t){"Enter"!==t.key||t.shiftKey||(t.preventDefault(),p())}),a.on("input",function(){this.style.height="auto",this.style.height=this.scrollHeight<100?this.scrollHeight+"px":"100px",i.prop("disabled",""===t(this).val().trim())}),i.on("click",function(){console.log("Send button clicked"),p()}),t(document).on("keydown",function(t){"Escape"===t.key&&e.hasClass("chatbot-visible")&&e.removeClass("chatbot-visible").addClass("chatbot-hidden")})};return{init:n}});